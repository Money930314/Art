<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>晨哥陶藝工作室</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css" rel="stylesheet">
  <style>
    :root{
      --primary-color:#000000;
      --secondary-color:#000000;
      --dark:#0f0f10;
      --light:#ffffff;
      --overlay:rgba(0,0,0,.6);
      --navH:80px;
    }
    *{box-sizing:border-box}
    body{font-family:'Segoe UI','Microsoft JhengHei',sans-serif;line-height:1.6;color:#333;background:#fefefe;margin:0}

    .hero-carousel{height:calc(100vh - var(--navH));position:relative;overflow:hidden}
    .carousel-item{height:calc(100vh - var(--navH));position:relative}
    .carousel-item::before{content:'';position:absolute;inset:0;background:var(--overlay);z-index:1}
    .hero-bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .carousel-caption{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:2;color:#fff;text-align:center}
    .carousel-caption h1{font-size:4rem;font-weight:300;margin-bottom:1rem}
    .carousel-caption p{font-size:1.3rem;margin-bottom:2rem}
    .btn-shop{background:#fff;color:#000;padding:12px 30px;border:0;border-radius:0;font-weight:700;text-transform:uppercase;letter-spacing:1px;transition:.3s}
    .btn-shop:hover{background:#000;color:#fff;transform:translateY(-2px)}

    nav.navbar{position:sticky;top:0;z-index:1020;padding:1rem 0;backdrop-filter:blur(10px);transition:background .25s, box-shadow .25s, color .25s}
    nav.navbar.nav-dark{background:rgba(0,0,0,.85)}
    nav.navbar.nav-dark .navbar-brand,
    nav.navbar.nav-dark .nav-link,
    nav.navbar.nav-dark .bi{color:#fff !important}
    nav.navbar.nav-light{background:rgba(255,255,255,.95); box-shadow:0 2px 18px rgba(0,0,0,.08)}
    nav.navbar.nav-light .navbar-brand,
    nav.navbar.nav-light .nav-link,
    nav.navbar.nav-light .bi{color:#111 !important}

    .navbar-brand{font-size:2.4rem;font-weight:800;letter-spacing:1px}
    .navbar-nav .nav-link{font-size:1.25rem;font-weight:600;padding:12px 18px;position:relative}
    .navbar-nav .nav-link::after{content:'';position:absolute;left:50%;bottom:6px;width:0;height:2px;background:currentColor;transition:all .2s}
    .navbar-nav .nav-link:hover::after{left:0;width:100%}
    .dropdown-menu{background:rgba(255,255,255,.97);border:0;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .navbar .dropdown-toggle::after { border: 0 !important; margin-left:0 !important; vertical-align:baseline !important; }

    section[data-theme]{scroll-margin-top:var(--navH)}
    .filter-section{padding:60px 0;background:#f8f9fa}
    .filter-controls{display:flex;justify-content:center;gap:20px;margin-bottom:40px;flex-wrap:wrap}
    .filter-btn{background:#fff;color:#000;border:2px solid #000;padding:10px 25px;border-radius:25px;font-weight:500;cursor:pointer;transition:.25s}
    .filter-btn:hover,.filter-btn.active{background:#000;color:#fff}
    .sort-select{border:2px solid #000;border-radius:25px;padding:10px 15px;background:#fff;color:#000;font-weight:500}
    .product-grid{padding:60px 0;background:#fff}
    .product-card{background:#fff;border-radius:15px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.1);transition:.3s;margin-bottom:30px;position:relative}
    .product-card:hover{transform:translateY(-8px);box-shadow:0 20px 40px rgba(0,0,0,.12)}
    .product-image{height:300px;background:linear-gradient(135deg,#f5f2eb 0%,#e8dcc0 100%);position:relative;overflow:hidden}
    .product-image img{width:100%;height:100%;object-fit:cover;transition:transform .3s}
    .product-card:hover .product-image img{transform:scale(1.05)}
    .placeholder-image{width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#999;font-size:16px;background:repeating-linear-gradient(45deg,#f0f0f0 0 10px,#e8e8e8 10px 20px)}
    .product-info{padding:25px}
    .product-category{color:#999;font-size:.9rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:5px}
    .product-name{font-size:1.5rem;color:#000;font-weight:600;margin-bottom:10px}
    .product-description{color:#666;line-height:1.6;margin-bottom:15px}
    .product-price{font-size:1.3rem;font-weight:700;color:#000;margin-bottom:15px}
    .sold-out-badge{position:absolute;top:15px;right:15px;background:#dc3545;color:#fff;padding:5px 12px;border-radius:15px;font-size:.8rem;font-weight:700}
    .btn-add-cart{width:100%;background:#000;color:#fff;border:0;padding:12px;border-radius:8px;font-weight:500;transition:.2s}
    .btn-add-cart:hover{background:#111;transform:translateY(-2px)}
    .btn-add-cart.sold-out{background:#6c757d;cursor:not-allowed}
    .btn-add-cart.sold-out:hover{background:#6c757d;transform:none}
    .about-section{background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%);padding:100px 0}
    .footer{background:#111;color:#fff;padding:60px 0 20px}
    .footer a{color:#eee;text-decoration:none}
    .footer a:hover{color:#fff}

    #mainNav.nav-light .badge-cart { background:#000; color:#fff; }
    #mainNav.nav-dark  .badge-cart { background:#fff; color:#000; }

    @media (max-width:768px){
      .carousel-caption h1{font-size:2.5rem}
      .carousel-caption p{font-size:1rem}
      .navbar-brand{font-size:2rem}
      .navbar-nav .nav-link{font-size:1.1rem;padding:10px 14px}
    }
  </style>
</head>
<body>
  <section id="home" class="hero-carousel" data-theme="dark">
    <div id="heroCarousel" class="carousel slide carousel-fade" data-bs-ride="carousel">
      <div class="carousel-indicators">
        <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="0" class="active"></button>
        <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="1"></button>
        <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="2"></button>
      </div>
      <div class="carousel-inner">
        <div class="carousel-item active">
          <div class="hero-bg placeholder-image">陶藝作品背景圖 1</div>
          <div class="carousel-caption">
            <h1>手作之美</h1>
            <p>用雙手塑造生活中的美好時光</p>
            <button class="btn btn-shop">SHOP NOW</button>
          </div>
        </div>
        <div class="carousel-item">
          <div class="hero-bg placeholder-image">陶藝作品背景圖 2</div>
          <div class="carousel-caption">
            <h1>工藝傳承</h1>
            <p>傳統技法與現代美學的完美融合</p>
            <button class="btn btn-shop">SHOP NOW</button>
          </div>
        </div>
        <div class="carousel-item">
          <div class="hero-bg placeholder-image">陶藝作品背景圖 3</div>
          <div class="carousel-caption">
            <h1>最新作品</h1>
            <p>每一件作品都承載著匠人的心血與溫度</p>
            <button class="btn btn-shop">SHOP NOW</button>
          </div>
        </div>
      </div>
      <button class="carousel-control-prev" type="button" data-bs-target="#heroCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon"></span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#heroCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon"></span>
      </button>
    </div>
  </section>

  <nav class="navbar navbar-expand-lg nav-dark navbar-dark" id="mainNav">
    <div class="container">
      <a class="navbar-brand" href="#">晨哥</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav mx-auto">
          <li class="nav-item"><a class="nav-link" href="#home">首頁</a></li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">作品分類</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#" data-category="teaware">茶具系列</a></li>
              <li><a class="dropdown-item" href="#" data-category="dinnerware">餐具系列</a></li>
              <li><a class="dropdown-item" href="#" data-category="decorative">裝飾系列</a></li>
              <li><a class="dropdown-item" href="#" data-category="functional">生活用品</a></li>
            </ul>
          </li>
          <li class="nav-item"><a class="nav-link" href="#gallery">全部作品</a></li>
          <li class="nav-item"><a class="nav-link" href="#about">作品文章</a></li>
        </ul>
        <div class="d-flex align-items-center gap-3">
          <a href="#"><i class="bi bi-instagram"></i></a>
          <a href="#"><i class="bi bi-youtube"></i></a>
          <a href="#"><i class="bi bi-search"></i></a>
          <div id="accountArea">
            <a href="#" id="userBtn" data-bs-toggle="modal" data-bs-target="#authModal"><i class="bi bi-person"></i></a>
          </div>
          <a href="#" id="cartToggle" class="position-relative" data-bs-toggle="offcanvas" data-bs-target="#cartDrawer" aria-controls="cartDrawer">
            <i class="bi bi-cart"></i>
            <span id="cartCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill badge-cart">0</span>
          </a>
        </div>
      </div>
    </div>
  </nav>

  <section class="filter-section" id="gallery" data-theme="light">
    <div class="container">
      <div class="row">
        <div class="col-12 text-center mb-5">
          <h2 class="display-4 mb-4" style="color:#000;">精選作品</h2>
        </div>
      </div>
      <div class="filter-controls">
        <button class="filter-btn active" data-filter="all">全部作品</button>
        <button class="filter-btn" data-filter="teaware">茶具系列</button>
        <button class="filter-btn" data-filter="dinnerware">餐具系列</button>
        <button class="filter-btn" data-filter="decorative">裝飾系列</button>
        <button class="filter-btn" data-filter="functional">生活用品</button>
        <select class="sort-select ms-3">
          <option value="name">依名稱排序</option>
          <option value="price-low">價格：低到高</option>
          <option value="price-high">價格：高到低</option>
          <option value="newest">最新作品</option>
        </select>
      </div>
    </div>
  </section>

  <section class="product-grid" data-theme="light">
    <div class="container">
      <div class="row" id="productGrid"></div>
    </div>
  </section>

  <section class="about-section" id="about" data-theme="light">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-lg-6">
          <h2 class="display-4 mb-4" style="color:#000;">關於工作室</h2>
          <p class="lead mb-4">我們專注於傳統陶藝技法與現代設計的融合，每一件作品都是獨一無二的藝術品。</p>
          <p class="mb-4">從選土、拉坯、修坯到燒製，每個步驟都傾注了我們對陶藝的熱愛與堅持。工作室成立於2020年，致力於創造實用與美感兼具的陶瓷器皿。</p>
        </div>
        <div class="col-lg-6">
          <div class="placeholder-image" style="height:400px;border-radius:15px">工作室照片</div>
        </div>
      </div>
    </div>
  </section>

  <section id="profile" class="container py-5" data-theme="light" data-auth="authed" hidden>
    <h3 class="mb-3">會員資料</h3>
    <form id="profileForm" class="vstack gap-3" style="max-width:520px">
      <input class="form-control" id="pf_name" placeholder="姓名">
      <input class="form-control" id="pf_phone" placeholder="電話">
      <input class="form-control" id="pf_addr" placeholder="地址">
      <button class="btn btn-dark" type="submit">儲存</button>
    </form>
  </section>

  <section id="admin" class="container py-5" data-theme="light" data-auth="authed" hidden>
    <h3 class="mb-3">會員管理（僅管理員）</h3>
    <div id="userTableWrap" class="table-responsive"></div>
  </section>

  <footer class="footer" data-theme="dark">
    <div class="container">
      <div class="row">
        <div class="col-lg-4 mb-4">
          <h5>晨哥陶藝工作室</h5>
          <p>每一件作品都承載著匠人的心血與溫度，用雙手塑造生活中的美好時光。</p>
        </div>
        <div class="col-lg-4 mb-4">
          <h5>聯絡資訊</h5>
          <p><i class="bi bi-telephone me-2"></i> 0912-345-678</p>
          <p><i class="bi bi-envelope me-2"></i> pottery@studio.com</p>
          <p><i class="bi bi-geo-alt me-2"></i> 台中市西區美術館附近</p>
        </div>
        <div class="col-lg-4 mb-4">
          <h5>追蹤我們</h5>
          <div class="social-icons">
            <a href="#"><i class="bi bi-instagram"></i></a>
            <a href="#"><i class="bi bi-youtube"></i></a>
            <a href="#"><i class="bi bi-facebook"></i></a>
          </div>
        </div>
      </div>
      <hr>
      <div class="row">
        <div class="col-12 text-center">
          <p>&copy; 2025 晨哥陶藝工作室 版權所有</p>
        </div>
      </div>
    </div>
  </footer>

  <div class="offcanvas offcanvas-end" tabindex="-1" id="cartDrawer" aria-labelledby="cartDrawerLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="cartDrawerLabel">購物車</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="關閉"></button>
    </div>
    <div class="offcanvas-body">
      <ul id="cartList" class="list-group mb-3"></ul>
      <div class="d-flex justify-content-between align-items-center mb-3">
        <span class="text-muted">小計</span>
        <strong id="cartSubtotal">NT$ 0</strong>
      </div>
      <button id="btnCheckout" class="btn btn-dark w-100" disabled>前往結帳</button>
      <div class="form-text mt-2">* 需登入會員才可結帳（示範）。</div>
    </div>
  </div>

  <div class="modal fade" id="authModal" tabindex="-1" aria-labelledby="authModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="authModalLabel">會員登入 / 註冊</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
        </div>
        <div class="modal-body">
          <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="pills-login-tab" data-bs-toggle="pill" data-bs-target="#pills-login" type="button" role="tab">登入</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="pills-signup-tab" data-bs-toggle="pill" data-bs-target="#pills-signup" type="button" role="tab">註冊</button>
            </li>
          </ul>
          <div class="tab-content" id="pills-tabContent">
            <div class="tab-pane fade show active" id="pills-login" role="tabpanel">
              <form id="loginForm" class="vstack gap-3">
                <input type="email" class="form-control" id="loginEmail" placeholder="Email" required>
                <input type="password" class="form-control" id="loginPassword" placeholder="密碼" required>
                <div class="d-flex justify-content-between align-items-center">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="rememberMe">
                    <label class="form-check-label" for="rememberMe">記住我</label>
                  </div>
                  <button type="submit" class="btn btn-dark">登入</button>
                </div>
              </form>
            </div>
            <div class="tab-pane fade" id="pills-signup" role="tabpanel">
              <form id="signupForm" class="vstack gap-3">
                <input type="text" class="form-control" id="signupName" placeholder="姓名" required>
                <input type="email" class="form-control" id="signupEmail" placeholder="Email" required>
                <input type="password" class="form-control" id="signupPassword" placeholder="密碼（至少 6 碟）" minlength="6" required>
                <button type="submit" class="btn btn-dark">註冊並登入</button>
              </form>
            </div>
          </div>
          <div class="form-text mt-3">* 使用 Supabase Auth；資料存入 profiles 表。<br>
          <!--
          Supabase SQL（請在 SQL Editor 執行一次）
          --------------------------------------------------------------
          create table if not exists public.profiles (
            id uuid primary key references auth.users(id) on delete cascade,
            full_name text,
            phone text,
            address text,
            is_admin boolean default false,
            created_at timestamptz default now(),
            updated_at timestamptz default now()
          );
          create or replace function public.handle_new_user()
          returns trigger as $$
          begin
            insert into public.profiles (id, full_name)
            values (new.id, COALESCE(new.raw_user_meta_data->>'name',''));
            return new;
          end;
          $$ language plpgsql security definer;
          drop trigger if exists on_auth_user_created on auth.users;
          create trigger on_auth_user_created
            after insert on auth.users
            for each row execute procedure public.handle_new_user();
          alter table public.profiles enable row level security;
          create policy "read own" on public.profiles for select using (id = auth.uid());
          create policy "update own" on public.profiles for update using (id = auth.uid());
          create policy "admin read all" on public.profiles for select
            using (exists (select 1 from public.profiles p where p.id = auth.uid() and p.is_admin = true));
          create policy "admin update all" on public.profiles for update
            using (exists (select 1 from public.profiles p where p.id = auth.uid() and p.is_admin = true));
          --------------------------------------------------------------
          -- 把某個使用者升級為管理員：
          -- update public.profiles set is_admin = true where id = 'YOUR-USER-ID';
          -- ------------------------------------------------------------>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    function setNavHeightVar(){
      const nav = document.getElementById('mainNav');
      if(!nav) return;
      const h = nav.offsetHeight || 80;
      document.documentElement.style.setProperty('--navH', h + 'px');
    }
    window.addEventListener('resize', setNavHeightVar, {passive:true});
    document.addEventListener('DOMContentLoaded', setNavHeightVar);
    setNavHeightVar();

    (function() {
      const nav = document.getElementById('mainNav');
      const themedBlocks = Array.from(document.querySelectorAll('section[data-theme], footer[data-theme]'));
      let lastTheme = null;
      function updateNavTheme() {
        const navH = nav.offsetHeight;
        const current = themedBlocks.find(el => {
          const r = el.getBoundingClientRect();
          return r.top <= navH && r.bottom > navH;
        }) || themedBlocks[0];
        const theme = (current?.getAttribute('data-theme')) || 'light';
        if (theme !== lastTheme) {
          nav.classList.toggle('nav-dark', theme === 'dark');
          nav.classList.toggle('nav-light', theme === 'light');
          nav.classList.toggle('navbar-dark', theme === 'dark');
          nav.classList.toggle('navbar-light', theme === 'light');
          lastTheme = theme;
        }
      }
      window.addEventListener('scroll', updateNavTheme, {passive:true});
      window.addEventListener('resize', updateNavTheme);
      document.addEventListener('DOMContentLoaded', updateNavTheme);
      updateNavTheme();
    })();
  </script>

  <script>
    const products=[
      {id:1,name:'青瓷茶壺',category:'teaware',description:'傳統拉坯技法製作，青瓷釉面溫潤如玉，容量350ml',price:1800,priceText:'NT$ 1,800',image:null,available:true,featured:true},
      {id:2,name:'手工茶杯組',category:'teaware',description:'一組四入，每只杯子都有獨特的釉色變化',price:1200,priceText:'NT$ 1,200',image:null,available:true,featured:false},
      {id:3,name:'白瓷花器',category:'decorative',description:'簡約現代造型，純白釉面，適合各種花材',price:680,priceText:'NT$ 680',image:null,available:false,featured:true},
      {id:4,name:'手沖咖啡濾杯',category:'functional',description:'V60造型，內壁螺旋紋路，完美萃取咖啡精華',price:450,priceText:'NT$ 450',image:null,available:true,featured:false},
      {id:5,name:'竹節餐具組',category:'dinnerware',description:'竹節造型碗盤組合，自然質樸的餐桌美學',price:950,priceText:'NT$ 950',image:null,available:true,featured:true},
      {id:6,name:'香薰燭台',category:'decorative',description:'鏤空設計，光影交錯，營造溫馨氛圍',price:520,priceText:'NT$ 520',image:null,available:true,featured:false},
      {id:7,name:'日式湯碗',category:'dinnerware',description:'深碗造型，適合盛裝湯品，釉色深邃如夜空',price:380,priceText:'NT$ 380',image:null,available:true,featured:false},
      {id:8,name:'文房筆筒',category:'functional',description:'古樸典雅，書房必備，底部防滑設計',price:420,priceText:'NT$ 420',image:null,available:true,featured:false},
      {id:9,name:'薄胎茶盞',category:'teaware',description:'超薄胎體，輕若蟬翼，品茶極品',price:2200,priceText:'NT$ 2,200',image:null,available:true,featured:true}
    ];
    let filteredProducts=[...products];
    function getCategoryName(k){const m={teaware:'茶具系列',dinnerware:'餐具系列',decorative:'裝飾系列',functional:'生活用品'};return m[k]||'其他'}
    function renderProducts(list=filteredProducts){
      const grid=document.getElementById('productGrid');
      grid.innerHTML=list.map(p=>`
        <div class="col-lg-4 col-md-6 product-item" data-category="${p.category}">
          <div class="product-card">
            ${!p.available?'<div class="sold-out-badge">售完</div>':''}
            <div class="product-image">
              ${p.image?`<img src="${p.image}" alt="${p.name}">`:`<div class="placeholder-image">${p.name}</div>`}
            </div>
            <div class="product-info">
              <div class="product-category">${getCategoryName(p.category)}</div>
              <h3 class="product-name">${p.name}</h3>
              <p class="product-description">${p.description}</p>
              <div class="product-price">${p.priceText}</div>
              <button class="btn btn-add-cart ${!p.available?'sold-out':''}" ${!p.available?'disabled':''} data-id="${p.id}">
                ${p.available?'加入購物車':'售完'}
              </button>
            </div>
          </div>
        </div>`).join('');
      renderCart();
    }
    function filterProducts(cat){filteredProducts=(cat==='all')?[...products]:products.filter(p=>p.category===cat);renderProducts();document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));const btn=document.querySelector(`[data-filter="${cat}"]`);if(btn)btn.classList.add('active')}
    function sortProducts(mode){switch(mode){case 'name':filteredProducts.sort((a,b)=>a.name.localeCompare(b.name,'zh-TW'));break;case 'price-low':filteredProducts.sort((a,b)=>a.price-b.price);break;case 'price-high':filteredProducts.sort((a,b)=>b.price-a.price);break;case 'newest':filteredProducts.sort((a,b)=>b.id-a.id);break;}renderProducts()}
    document.addEventListener('DOMContentLoaded',()=>{
      renderProducts();
      document.querySelectorAll('.filter-btn').forEach(btn=>btn.addEventListener('click',()=>filterProducts(btn.getAttribute('data-filter'))));
      document.querySelectorAll('.dropdown-item').forEach(item=>item.addEventListener('click',e=>{e.preventDefault();const c=item.getAttribute('data-category');if(c){filterProducts(c);document.getElementById('gallery').scrollIntoView({behavior:'smooth'})}}));
      document.querySelector('.sort-select').addEventListener('change',function(){sortProducts(this.value)});
      document.querySelectorAll('a[href^="#"]').forEach(a=>a.addEventListener('click',e=>{const href=a.getAttribute('href');if(href&&href.startsWith('#')&&href.length>1){e.preventDefault();const t=document.querySelector(href);if(t)t.scrollIntoView({behavior:'smooth',block:'start'})}}));
    });
  </script>

  <script>
    const CART_KEY = 'cart:v1';
    const cart = {
      items: {},
      load(){ try{ this.items = JSON.parse(localStorage.getItem(CART_KEY)) || {}; }catch{ this.items = {}; } },
      save(){ localStorage.setItem(CART_KEY, JSON.stringify(this.items)); },
      add(id, qty=1){
        const p = products.find(x=>x.id===id);
        if(!p || !p.available) return;
        const item = this.items[id] || { id, name:p.name, price:p.price, image:p.image||null, qty:0 };
        item.qty += qty; this.items[id]=item; this.save(); renderCart();
      },
      setQty(id, qty){
        qty = Math.max(0, parseInt(qty||0,10));
        if(qty<=0) delete this.items[id];
        else if(this.items[id]) this.items[id].qty = qty;
        this.save(); renderCart();
      },
      remove(id){ delete this.items[id]; this.save(); renderCart(); },
      count(){ return Object.values(this.items).reduce((a,b)=>a+b.qty,0); },
      subtotal(){ return Object.values(this.items).reduce((a,b)=>a+b.qty*b.price,0); }
    };
    function money(n){ return 'NT$ ' + (n||0).toLocaleString('zh-TW'); }
    function renderCart(){
      const list = document.getElementById('cartList');
      const items = Object.values(cart.items);
      if(!items.length){
        list.innerHTML = '<li class="list-group-item text-center text-muted">購物車是空的</li>';
      }else{
        list.innerHTML = items.map(it=>`
          <li class="list-group-item">
            <div class="d-flex align-items-start gap-2">
              <div class="flex-grow-1">
                <div class="d-flex justify-content-between">
                  <strong>${it.name}</strong>
                  <span>${money(it.price * it.qty)}</span>
                </div>
                <div class="d-flex align-items-center gap-2 mt-2">
                  <button class="btn btn-sm btn-outline-secondary qty-dec" data-id="${it.id}">-</button>
                  <input type="number" min="1" class="form-control form-control-sm qty-input" value="${it.qty}" data-id="${it.id}" style="width:70px">
                  <button class="btn btn-sm btn-outline-secondary qty-inc" data-id="${it.id}">+</button>
                  <button class="btn btn-sm btn-outline-danger ms-auto remove" data-id="${it.id}"><i class="bi bi-trash"></i></button>
                </div>
              </div>
            </div>
          </li>
        `).join('');
      }
      document.getElementById('cartSubtotal').textContent = money(cart.subtotal());
      document.getElementById('cartCount').textContent = cart.count();
      document.getElementById('btnCheckout').disabled = !items.length;
    }
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.btn-add-cart[data-id]');
      if(btn){ const id = +btn.dataset.id; cart.add(id, 1); }
    });
    document.getElementById('cartList').addEventListener('click', (e)=>{
      const inc = e.target.closest('.qty-inc');
      const dec = e.target.closest('.qty-dec');
      const rm  = e.target.closest('.remove');
      if(inc){ const id = +inc.dataset.id; cart.setQty(id, (cart.items[id]?.qty||1)+1); }
      if(dec){ const id = +dec.dataset.id; cart.setQty(id, (cart.items[id]?.qty||1)-1); }
      if(rm){ const id = +rm.dataset.id; cart.remove(id); }
    });
    document.getElementById('cartList').addEventListener('change',(e)=>{
      const inp = e.target.closest('.qty-input'); if(inp){ cart.setQty(+inp.dataset.id, inp.value); }
    });
    document.addEventListener('DOMContentLoaded', ()=>{ cart.load(); renderCart(); });
  </script>

  <script>
    const API_BASE =
      location.origin.startsWith('http')
        ? ''
        : 'https://YOUR_VERCEL_DOMAIN_HERE';

    document.getElementById('btnCheckout').addEventListener('click', async () => {
      if (!(await Auth.isLoggedIn())) { new bootstrap.Modal('#authModal').show(); return; }

      const items = Object.values(cart.items).map(it => ({
        name: it.name, price: it.price, qty: it.qty, product_id: it.id
      }));

      if (!items.length) { alert('購物車是空的'); return; }

      try {
        const user = await Auth.currentUser();
        const resp = await fetch(`${API_BASE}/api/checkout-ecpay`, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({
            items,
            email: user?.email || '',
            name:  user?.name  || '',
            user_id: user?.id || null
          })
        });

        const ct = resp.headers.get('content-type') || '';
        const text = await resp.text();

        if (resp.ok && ct.includes('text/html')) {
          document.open(); document.write(text); document.close();
        } else {
          alert(`結帳發生錯誤（${resp.status}）：\n${text}`);
        }
      } catch (err) {
        console.error(err);
        alert('結帳連線失敗，請稍後重試');
      }
    });
  </script>

  <script>
    const SUPABASE_URL  = 'https://xugiulbaduyiypwrzwgk.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh1Z2l1bGJhZHV5aXlwd3J6d2drIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzEzMTgsImV4cCI6MjA3MDEwNzMxOH0.J2UAw80o2e5wXPn9v6Dw_h_Xy9EcqR2owPn1E_BfhwE';

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    function closeAuthModal(){
      const el = document.getElementById('authModal');
      const inst = bootstrap.Modal.getOrCreateInstance(el);
      inst.hide();
      document.body.classList.remove('modal-open');
      document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
    }

    async function fetchMyProfile(){
      const { data: { user } } = await sb.auth.getUser();
      if(!user) return null;
      const { data, error } = await sb.from('profiles').select('*').eq('id', user.id).single();
      if(error) return null;
      return data;
    }

    const Auth = {
      async isLoggedIn(){
        const { data: { session } } = await sb.auth.getSession();
        return !!session?.user;
      },
      async currentUser(){
        const { data: { user } } = await sb.auth.getUser();
        if(!user) return null;
        let name = user.user_metadata?.name || '';
        try{
          const p = await fetchMyProfile();
          if(p?.full_name) name = p.full_name;
        }catch{}
        return { id:user.id, email:user.email, name };
      },
      async logout(){ await sb.auth.signOut(); refreshAccountUI(); }
    };

    async function refreshAccountUI(){
      const area = document.getElementById('accountArea');
      const authed = await Auth.isLoggedIn();
      if(!authed){
        area.innerHTML = '<a href="#" id="userBtn" data-bs-toggle="modal" data-bs-target="#authModal"><i class="bi bi-person"></i></a>';
        document.querySelectorAll('[data-auth="authed"]').forEach(el=>el.hidden = true);
        return;
      }
      const user = await Auth.currentUser();
      document.querySelectorAll('[data-auth="authed"]').forEach(el=>el.hidden = false);
      const isAdmin = await checkIsAdmin();
      area.innerHTML = `
        <div class="dropdown">
          <a class="d-inline-flex align-items-center text-decoration-none dropdown-toggle" href="#" data-bs-toggle="dropdown">
            <i class="bi bi-person-circle me-1"></i><span>Hi, ${user?.name || '會員'}</span>
          </a>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="#profile" id="btnProfileLink">我的資料</a></li>
            ${isAdmin ? '<li><a class="dropdown-item" href="#admin" id="btnAdminLink">會員管理</a></li>' : ''}
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#" id="btnLogout">登出</a></li>
          </ul>
        </div>`;
      area.querySelector('#btnLogout')?.addEventListener('click', async (e)=>{ e.preventDefault(); await Auth.logout(); });
      area.querySelector('#btnProfileLink')?.addEventListener('click', (e)=>{ e.preventDefault(); document.querySelector('#profile')?.scrollIntoView({behavior:'smooth'}); });
      area.querySelector('#btnAdminLink')?.addEventListener('click', (e)=>{ e.preventDefault(); document.querySelector('#admin')?.scrollIntoView({behavior:'smooth'}); });
    }

    document.getElementById('loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const pass  = document.getElementById('loginPassword').value;
      const { error } = await sb.auth.signInWithPassword({ email, password: pass });
      if(error){ alert(error.message); return; }
      closeAuthModal();
      refreshAccountUI();
      await loadProfileUI();
      await loadAdminUsers();
    });

    document.getElementById('signupForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const name = document.getElementById('signupName').value;
      const email= document.getElementById('signupEmail').value;
      const pass = document.getElementById('signupPassword').value;
      const { error } = await sb.auth.signUp({ email, password: pass, options: { data: { name } } });
      if(error){ alert(error.message); return; }
      try{ await sb.auth.signInWithPassword({ email, password: pass }); }catch{}
      closeAuthModal();
      refreshAccountUI();
      await loadProfileUI();
      await loadAdminUsers();
    });

    async function loadProfileUI(){
      const p = await fetchMyProfile(); if(!p) { document.querySelector('#profile')?.setAttribute('hidden',''); return; }
      document.querySelector('#profile')?.removeAttribute('hidden');
      pf_name.value = p.full_name || '';
      pf_phone.value = p.phone || '';
      pf_addr.value = p.address || '';
    }
    profileForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const { data: { user } } = await sb.auth.getUser(); if(!user){ alert('未登入'); return; }
      const patch = {
        full_name: pf_name.value.trim(),
        phone: pf_phone.value.trim(),
        address: pf_addr.value.trim(),
        updated_at: new Date().toISOString()
      };
      const { error } = await sb.from('profiles').update(patch).eq('id', user.id);
      if(error){ alert(error.message); return; }
      alert('已儲存');
      refreshAccountUI();
    });

    async function checkIsAdmin(){
      const { data: { user } } = await sb.auth.getUser(); if(!user) return false;
      const { data } = await sb.from('profiles').select('is_admin').eq('id', user.id).single();
      return !!data?.is_admin;
    }

    async function loadAdminUsers(){
      if(!(await checkIsAdmin())){ document.querySelector('#admin')?.setAttribute('hidden',''); return; }
      document.querySelector('#admin')?.removeAttribute('hidden');
      const { data, error } = await sb.from('profiles')
        .select('id, full_name, phone, address, is_admin, created_at')
        .order('created_at', { ascending:false });
      if(error){ alert(error.message); return; }
      const rows = (data||[]).map(p=>`
        <tr>
          <td style="font-family:monospace">${p.id}</td>
          <td>${p.full_name||''}</td>
          <td>${p.phone||''}</td>
          <td>${p.address||''}</td>
          <td>${p.is_admin ? '✔︎':''}</td>
          <td>${new Date(p.created_at).toLocaleString()}</td>
        </tr>`).join('');
      userTableWrap.innerHTML = `
        <table class="table table-sm align-middle">
          <thead><tr>
            <th>User ID</th><th>姓名</th><th>電話</th><th>地址</th><th>Admin</th><th>註冊時間</th>
          </tr></thead>
          <tbody>${rows}</tbody>
        </table>`;
    }

    (async ()=>{
      await refreshAccountUI();
      if(await Auth.isLoggedIn()){ await loadProfileUI(); await loadAdminUsers(); }
    })();

    sb.auth.onAuthStateChange(async (_event, session)=>{
      await refreshAccountUI();
      if(session?.user){ await loadProfileUI(); await loadAdminUsers(); }
    });
  </script>
</body>
</html>

